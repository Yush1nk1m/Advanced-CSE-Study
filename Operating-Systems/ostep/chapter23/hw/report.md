# OSTEP Chapter 23 Homework

## Problem 1

    TLB 미스에 대해 하드웨어가 검색을 한다는 가정 하에 선형 페이지 테이블을 사용하면 페이지 테이블의 위치를 찾기 위해 하나의 레지스터가 필요하다. 2단계 페이지 테이블을 사용하는 경우에는 몇 개의 레지스터가 필요한가? 3단계 페이지 테이블을 사용하는 경우는 몇 개가 필요한가?

선형 페이지 테이블을 사용할 때는 베이스/바운드 레지스터가 필요하다. 멀티 레벨 페이지 테이블을 사용하는 이유는 페이지 테이블을 분산된 위치에 저장해서 동적인 할당 공간을 절약하기 위함인데, 이는 즉 페이지가 연속적인 위치에 저장되어 있지 않다는 의미와 같다. 그러므로 멀티 레벨 페이지 테이블을 사용할 때 페이지 테이블의 시작점을 특정하기 위해 레지스터를 사용한다면 분산된 공간 각각에 대해 베이스/바운드 레지스터를 갖고 있어야 한다. 이는 $N$ 단계의 페이지 테이블 각각이 $k$ 개의 페이지 테이블 엔트리를 갖고 있다고 한다면 $k^N$ 개의 레지스터가 필요하다는 의미이며 매우 비현실적이다.

하지만 실제 멀티 레벨 페이지 테이블은 트리 구조이기 때문에 각각의 페이지 테이블 엔트리(노드)는 다음 단계 페이지의 상대적인 위치를 갖고 있고, 바운드 값도 해당 단계 페이지 테이블 구성을 위해 가상 주소의 몇 비트가 사용되는지를 통해 계산할 수 있기 때문에 2단계이든, 3단계이든 상관없이 첫 번째 단계의 페이지 테이블 위치를 특정하기 위한 한 쌍의 베이스/바운드 레지스터만 필요할 뿐이다.

즉, 멀티 레벨 페이지 테이블은 트리 구조를 갖기 때문에 일단 트리의 루트 노드(페이지 디렉터리)의 위치를 특정한다면 리프 노드(물리 페이지)까지는 트리 내 노드들의 정보만으로 도달할 수 있다. 하지만 트리의 루트 노드가 어디 있는지에 대한 정보는 유지하고 있어야 하고, 이것이 멀티 레벨 페이지 테이블의 단계와 상관없이 단 한 쌍의 베이스/바운드 레지스터에 저장되는 것이다.

## Problem 2

    시뮬레이터를 이용하여 변환을 수행하여 보자. 이때 랜덤 시드는 0과 1 그리고 2를 사용하여 보자. -c 플래그를 사용하여 답이 맞는지 확인해 보자. 각 검색을 수행하기 위해서 몇 번의 메모리 참조가 필요한가?

**paging-multilevel-translate.py output**

```bash
$ python paging-multilevel-translate.py -s 0 -c
ARG seed 0
ARG allocated 64
ARG num 10

page   0:1b1d05051d0b19001e00121c1909190c0f0b0a1218151700100a061c06050514
page   1:0000000000000000000000000000000000000000000000000000000000000000
page   2:121b0c06001e04130f0b10021e0f000c17091717071e001a0f0408120819060b
page   3:7f7f7f7fcd7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f887f7f7f7f7f7f7f7fb9
page   4:0b041004051c13071b131d0e1b150107080507071b0e1b0411001c000c181e00
page   5:17131d0a1202111906081507081d1e041b1101121301171902140e070e040a14
page   6:0000000000000000000000000000000000000000000000000000000000000000
page   7:0000000000000000000000000000000000000000000000000000000000000000
page   8:11101a120f10180a11151e151d0c12170a081e0a1e1a06191e08141702190915
page   9:0000000000000000000000000000000000000000000000000000000000000000
page  10:0000000000000000000000000000000000000000000000000000000000000000
page  11:0910141d04011a18170e150c050c18181d1b151016051c16120d13131b11060d
page  12:060b16191c05141d01141a0a07120d050e0c110f090b19071100160a0108071d
page  13:19100b0e000614140f1d0e091a08121519180b0101161d0a0d16140814090b10
page  14:1218140b000d1c0a07040f10020c141d0d0d0e060c140c12191e1b0b00120e07
page  15:0000000000000000000000000000000000000000000000000000000000000000
page  16:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fea7f7f7f
page  17:0000000000000000000000000000000000000000000000000000000000000000
page  18:7f7f7f7f7f7fab7f7f7f8e7f7f7fdd7f7f7f7f7f7f7f8b7f7f7f7f7f7f7f7f7f
page  19:00130001061402011e0d1b060d0b050a1e170b0c081016150e011c0c0c00041a
page  20:1a190402020c1d110807030419041a190411001a11170f151c111b0a03000719
page  21:0b081b0e1c151e121e050d111e111a130f0c0b09061d101a1b1d070a13090417
page  22:1212150f081b0a0e130f1d1d1c1c120f150608010500140418151e0c1c0e0a03
page  23:1d0f030b0c0f1e1e1113140f0f091502091b071d1e110102060a03180b07010b
page  24:0000000000000000000000000000000000000000000000000000000000000000
page  25:03031c031b0e0e0a0c0b110a1907070e1c0016000c170d0d070e070814121c1e
page  26:090e1d18081115180d0c170d070e1d040e130e06001513000917131004150e15
page  27:0000000000000000000000000000000000000000000000000000000000000000
page  28:0f1d0f0a0211070b0b17071d170e1b0b0b04180c0f0e140b1c0d0b0c171e1a0e
page  29:17081e031b010710120c030708171c120118090a10071c050c08101113100c13
page  30:7f7f7f7f7f847f7f7f7f977fbd7f7ff47f7f7f7f7f7f7f7f7f7f7f7f7f7f9c7f
page  31:7f7f7f7f7f7fd07f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  32:0000000000000000000000000000000000000000000000000000000000000000
page  33:7f7f7f7f7f7f7f7fb57f9d7f7f7f7f7f7f7f7f7f7f7f7f7f7f7ff6b17f7f7f7f
page  34:0413050d0c02161518101105060710190b1b16160a031d1a0c1a1b0a0f0a151c
page  35:0000000000000000000000000000000000000000000000000000000000000000
page  36:1d1313160c0c1400050a07130b1b110c0c150c14010d0804100f11171b0f090e
page  37:1e0f0a0d0c100c021e1e05070d15001913081a1409101e01151a150412180c12
page  38:0000000000000000000000000000000000000000000000000000000000000000
page  39:1b111e171108150e160c0f001601151218081506100a1e1e06110a1e1c121615
page  40:0d030b1007190b0709191c1d0017100307080c0e1d01151a0b07060904110700
page  41:7f7f7f7f7f7f7f7fe57f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f8d7f7f7f7f7f
page  42:03041501111c1015001312110c0b1e01001d050306181d000d030806140a050f
page  43:190802041311011e0e0916000d141d171b030d00080b0a0b180519100a11050f
page  44:7f7f7f7f7f7fcc7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fa27f7f7f7f7f7f
page  45:7fb27fef7f7f7f7fa4f57f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  46:0000000000000000000000000000000000000000000000000000000000000000
page  47:070a0f1002090b0c0e0d020613190f0402040b111410110a14160c19171c0e0a
page  48:0000000000000000000000000000000000000000000000000000000000000000
page  49:1e0a0f0702030d13101003010b1d05080e1c1d00140714171b151a1804011610
page  50:161b040706011a0f020d0d181704130f0004140b1d0f15040e1619060c0e0d0e
page  51:14000f1a070a1a0511071d180d02090f1c0311151019101d12120d120b110905
page  52:0000000000000000000000000000000000000000000000000000000000000000
page  53:0f0c18090e121c0f081713071c1e191b09161b150e030d121c1d0e1a08181100
page  54:1901050f031b1c090d11081006090d121008070318031607081614160f1a0314
page  55:0000000000000000000000000000000000000000000000000000000000000000
page  56:0000000000000000000000000000000000000000000000000000000000000000
page  57:1c1d1602020b000a001e19021b0606141d03000b00121a05030a1d041d0b0e09
page  58:0000000000000000000000000000000000000000000000000000000000000000
page  59:0000000000000000000000000000000000000000000000000000000000000000
page  60:0000000000000000000000000000000000000000000000000000000000000000
page  61:010510020c0a0c031c0e1a1e0a0e150d09161b1c130b1e1302021701000c100d
page  62:7f7f7fa87f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  63:0612060a1d1b19010407181a12161902021a010601001a0a0404141e0f1b0f11
page  64:18121708080d1e161d10111e0518181a1704141c110b1d110c13180700101d15
page  65:7f7f7f7f7f7f7f7f7f7f997f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  66:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fd77f7f
page  67:0000000000000000000000000000000000000000000000000000000000000000
page  68:121216020f060c0f0a0c16011d120511020f150d09141c1b0b1a03011e171311
page  69:190a19020d0a0d190f1e1a03090016001b050c01090c0117160b1902010b1b17
page  70:0000000000000000000000000000000000000000000000000000000000000000
page  71:7f7f7f7f7f7f7f7f7f7f7f857f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  72:180c0018050c0b030a051314000e111b0f02011a181a081402190a1d0e011c13
page  73:0000000000000000000000000000000000000000000000000000000000000000
page  74:0d0b1e08180d0b011a151b0d14030c06011d0604060b10041e1e040c151b0f1c
page  75:1a1c011b00141c0f0c0a1c1c13160a041e14081e120a1b021804030816120d04
page  76:0c11150c1b1d1e01191b041d03061d191108070c0013011702000817190f1d03
page  77:1c061606001b1a0205071c0b190d0b171308121519141312021d16081513140b
page  78:0e02171b1c1a1b1c100c1508191a1b121d110d141e1c1802120f131a07160306
page  79:1e1b1516071708030e0a050d1b0d0d1510041c0d180c190c06061d12010c0702
page  80:1b081d1c020d170d0f19151d051c1c131d071b171202000007170b18130c1b01
page  81:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fe27f7f7f7f7f7f7f7f7f7f7f7f7ffa
page  82:0000000000000000000000000000000000000000000000000000000000000000
page  83:0000000000000000000000000000000000000000000000000000000000000000
page  84:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f947f7f7f7f7fce
page  85:7f7f7f7f7f7f7f7f9a7fbf7f7f7f7f7f7f7f7f7faf7f7f7f7f7f7f7f7f7f7f7f
page  86:7f7f7f7f7f7f7fc57f7f7f7f7f7f7f7f7f7f7f7fca7f7fee7f7f7f7f7f7f7f7f
page  87:1805180d170e1802011c0f1b1d14110602191b18150d09030d111c1d0c031716
page  88:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fc47f7f7f7f7f7f7f7f7f7f7f7f
page  89:0000000000000000000000000000000000000000000000000000000000000000
page  90:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fc07f7f7f7f7f7f7f7fde7f7f7f7f7f7f
page  91:7f7f7f7f7f7f7f7f7f7f7f7fa57f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  92:0000000000000000000000000000000000000000000000000000000000000000
page  93:0a1a1907001905181505021c12130e0412071816001c01020904070b160c080f
page  94:1406190710140713080519110a1200040c1e0f021718181115061619170a1213
page  95:0a1d0f1d1e1915040012151d10151406131e0315130b18001b190e030e12070f
page  96:7f7f7f7f7f7f7f7f7f7f7f7f7f7fb67f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page  97:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fc87f7f7f7f7fe77f7f7f7f7f7f7f7f7f
page  98:15191803171a170e1503170818130f100201001804030b1e1b0919020c111e01
page  99:090b1304150b1204140a0e0c0e1509140109170113000e1b0010021a15171400
page 100:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fa77f7f7f7f7f7f7f7f7f7fe37f7f
page 101:0e0a00010b061005061416091a070a16011c020e1601191e0e030203170c1c0d7f7f7f7f7f7f7f7fb57f
page 102:1d031b0116000d1a0c1c1612050a0c121e080f1c0a13171317061d0512091309
page 103:1e171c061012190e180c121a181400050f07021a1d090c19011303081901010c
page 104:7f7f7f7f7f7f7f7f7f7f7f7f80aa7f7f7f7f7f7f7f7f7f7f7f7f7f7ff07f7f7f
page 105:b37f7f7f7f7f7f7f7f7f7f7f7f937f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f
page 106:160a000e1001110a00050310011c1a1d091c1e170814120c090103040e131701
page 107:7f7f7f7f7f7f7f7f7f7f7f7f7f7ff17f7f7f7f7f7f7f7f7ff37f7f7f7f7f7f7f
page 108:83fee0da7fd47febbe9ed5ade4ac90d692d8c1f89fe1ede9a1e8c7c2a9d1dbff
page 109:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f827f7f7f7f7f7f7f7f7f7f7f7f7f7f
page 110:1614041e0c120b010e0401131303110a0b180f1b120e130a03151318031c181c
page 111:08000115111d1d1c01171514161b130b10061200040a18160a1301051e080c11
page 112:19051e1302161e0c150906160019100303141b081e031a0c02080e181a041014
page 113:1d07111b1205071e091a181716181a01050f06100f03020019021d1e170d080c
page 114:0000000000000000000000000000000000000000000000000000000000000000
page 115:110601040d1406151a170d141e1b0a1505110b0d0d141a0e0417171d0c0e101b
page 116:0a130b11150f14171a05060f0f19101b180f190e0a0d0e1401161e0e02060307
page 117:1b0a170019111d0b130a18121e000401031c1d0e1d19181705110d1d05051404
page 118:1119021a1c05191a1b101206150c00040c1b111c1c02120a0f0e0e03190f130e
page 119:0000000000000000000000000000000000000000000000000000000000000000
page 120:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fcb7f7f7f7f7f7f7f7f7f7f7f7f7f
page 121:0000000000000000000000000000000000000000000000000000000000000000
page 122:051e0312041b1d18090717090d01040002020d1116040d13020d0b1d010c0c16
page 123:0000000000000000000000000000000000000000000000000000000000000000
page 124:0000000000000000000000000000000000000000000000000000000000000000
page 125:0000000000000000000000000000000000000000000000000000000000000000
page 126:7f7f7f7f7f7f7f7f8ce6cf7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f967f7f7f7f7f
page 127:7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7fdf7f7f7f7f7f7f7f7f7f7f7f7f957f7f

PDBR: 108  (decimal) [This means the page directory is held in this page]

Virtual Address 0x611c:
  --> pde index:0x18 [decimal 24] pde contents:0xa1 (valid 1, pfn 0x21 [decimal 33])
    --> pte index:0x8 [decimal 8] pte contents:0xb5 (valid 1, pfn 0x35 [decimal 53])
      --> Translates to Physical Address 0x6bc --> Value: 0x08
Virtual Address 0x3da8:
  --> pde index:0xf [decimal 15] pde contents:0xd6 (valid 1, pfn 0x56 [decimal 86])
    --> pte index:0xd [decimal 13] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])
      --> Fault (page table entry not valid)
Virtual Address 0x17f5:
  --> pde index:0x5 [decimal 5] pde contents:0xd4 (valid 1, pfn 0x54 [decimal 84])
    --> pte index:0x1f [decimal 31] pte contents:0xce (valid 1, pfn 0x4e [decimal 78])
      --> Translates to Physical Address 0x9d5 --> Value: 0x1c
Virtual Address 0x7f6c:
  --> pde index:0x1f [decimal 31] pde contents:0xff (valid 1, pfn 0x7f [decimal 127])
    --> pte index:0x1b [decimal 27] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])
      --> Fault (page table entry not valid)
Virtual Address 0x0bad:
  --> pde index:0x2 [decimal 2] pde contents:0xe0 (valid 1, pfn 0x60 [decimal 96])
    --> pte index:0x1d [decimal 29] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])
      --> Fault (page table entry not valid)
Virtual Address 0x6d60:
  --> pde index:0x1b [decimal 27] pde contents:0xc2 (valid 1, pfn 0x42 [decimal 66])
    --> pte index:0xb [decimal 11] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])
      --> Fault (page table entry not valid)
Virtual Address 0x2a5b:
  --> pde index:0xa [decimal 10] pde contents:0xd5 (valid 1, pfn 0x55 [decimal 85])
    --> pte index:0x12 [decimal 18] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])83fee0da7fd47febbe9ed5ade4ac90d692d8c1f89fe1ede9a1
      --> Fault (page table entry not valid)
Virtual Address 0x4c5e:
  --> pde index:0x13 [decimal 19] pde contents:0xf8 (valid 1, pfn 0x78 [decimal 120])
    --> pte index:0x2 [decimal 2] pte contents:0x7f (valid 0, pfn 0x7f [decimal 127])
      --> Fault (page table entry not valid)
Virtual Address 0x2592:
  --> pde index:0x9 [decimal 9] pde contents:0x9e (valid 1, pfn 0x1e [decimal 30])
    --> pte index:0xc [decimal 12] pte contents:0xbd (valid 1, pfn 0x3d [decimal 61])
      --> Translates to Physical Address 0x7b2 --> Value: 0x1b
Virtual Address 0x3e99:
  --> pde index:0xf [decimal 15] pde contents:0xd6 (valid 1, pfn 0x56 [decimal 86])
    --> pte index:0x14 [decimal 20] pte contents:0xca (valid 1, pfn 0x4a [decimal 74])
      --> Translates to Physical Address 0x959 --> Value: 0x1e
```

메모리에 있는 128개의 프레임 중 108번 프레임에 페이지 디렉터리가 저장되어 있다. 16진수 2글자가 8 비트(= 1 바이트)이므로 2글자를 1 바이트 단위로 끊어 읽을 수 있다. 그러므로 페이지의 크기는 32 바이트이고 페이지 디렉터리 인덱스, 페이지 테이블 인덱스, 오프셋이 각각 5 비트를 사용할 것임을 유추할 수 있다.

생성된 가상 주소 중 0x611c를 예로 들어 주소 변환 계산을 수행해 보자. 0x611c는 2 바이트 데이터로, 비트열로 표현하면 0110 0001 0001 1100 이다. MSB는 제외하고 나머지 15 비트로 주소를 분석하면 페이지 엔트리 인덱스는 11000$_{(2)}$ (= 24$_{(10)}$), 페이지 테이블 인덱스는 01000$_{(2)}$ (= 8$_{(10)}$), 오프셋은 11100$_{(2)}$ (= 28$_{(10)}$) 이다.

우선 페이지 엔트리 인덱스를 변환해 보자. 108번 프레임의 24번째 바이트는 0xa1 (= 1010 0001) 이고, MSB가 1이므로 유효하다. MSB를 제외한 비트열은 0010 0001 (= 33$_{(10)}$) 이므로 페이지 테이블은 33번 프레임에 저장되어 있음을 계산할 수 있다.

다음으로 페이지 테이블 인덱스를 변환해 보자. 33번 프레임의 8번째 바이트는 0xb5 (= 1011 0101) 이고, MSB가 1이므로 유효하다. MSB를 제외한 비트열은 0011 0101 (= 53$_{(10)}$) 이므로 페이지는 53번 프레임에 할당되었음을 계산할 수 있다.

마지막으로 오프셋을 변환한다. 53번 프레임의 28번째 바이트는 0x08 이다.

모든 변환을 수행하기 위해 다음과 같은 메모리 접근이 수행되었다.

1. 페이지 디렉터리 베이스 레지스터 값을 기준으로 페이지 디렉터리가 저장된 프레임 접근
2. 페이지 디렉터리 인덱스를 기준으로 페이지 테이블이 저장된 프레임 접근
3. 페이지 테이블 인덱스를 기준으로 데이터가 저장된 프레임 접근

이를 통해 $N$ 단계로 구성된 멀티 레벨 페이지 테이블 기법은 $N + 1$ 회의 메모리 접근이 요구된다는 것을 확인할 수 있다.

## Problem 3

    캐시 메모리가 어떻게 동작하는지 이해했다고 했을 때, 캐시를 사용하면 페이지 테이블에 대한 메모리 참조는 어떻게 동작할까? 캐시 히트가 많이 생겨날까 (그래서 빠르게 접근될 것인가)? 또는 많은 미스를 만들어 낼까 (그러므로 느리게 접근될 것인가)?

캐시 히트와 캐시 미스의 비율은 전적으로 참조의 지역성과 관련되어 있다. 만약 사용자가 같은 페이지를 반복적으로 참조한다면 캐시 히트 가능성이 올라가고, 캐시의 용량을 초과하는 정도로 다양한 페이지를 번갈아가며 참조한다면 캐시 미스 가능성이 올라간다.

데이터 참조의 지역성이 우수하다면 캐시 메모리는 매우 매력적인 선택이다. 앞서 살펴본 예시와 같이 2단계 멀티 레벨 페이지 테이블 정도만 되어도 캐시 없이는 데이터 참조를 위해 3번의 메모리 접근이 필요하다. 만약 캐시가 있다면 1번의 메모리 접근만으로 데이터 참조가 가능하게 되므로 성능이 압도적으로 좋을 것이다.

하지만 캐시 미스가 자주 발생한다면 캐시를 우선 참조한 후 3번의 메모리 접근 및 캐싱 작업이 추가적으로 필요하다. 이로 인해 오버헤드가 증가한다.

멀티 레벨 페이지 테이블은 구조적으로 캐시 히트를 자주 유도한다. 방대한 메모리 공간을 여러 단계로 분할한 것이기 때문에 각 단계에서 차지하는 공간이 크지 않고 웬만한 데이터 참조 패턴은 캐시 히트를 유도하게 된다.

현대 하드웨어에서 L1/L2/L3 캐시가 담당하는 작업이 바로 멀티 레벨 페이지 테이블 구조를 캐싱하는 것이다. 페이지 디렉터리, 페이지 테이블은 물리 메모리에도 존재하지만 한 번 L1/L2/L3 캐시에 캐싱되면 캐시 미스가 발생할 확률은 극도로 낮아진다. 이는 멀티 레벨 페이지 테이블이 트리 구조를 갖고 있기 때문이라고 생각할 수도 있다.

그러므로 캐시 사용은 페이지 테이블에 대한 메모리 참조 횟수를 획기적으로 줄일 수 있다. 주어진 프로그램에서는 캐시 메모리가 없다고 가정하고 $N$ 단계 멀티 레벨 페이지에서 데이터 참조를 위해 $N + 1$ 회의 메모리 참조가 필요하였지만 현대 하드웨어는 이러한 캐시 메모리가 존재하기 때문에 멀티 레벨 페이지를 사용하더라도 고속으로 데이터 참조가 가능하다.
